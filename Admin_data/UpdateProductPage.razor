@page "/admin/products/edit/{ProductId:int}"

<PageTitle>Edit Product</PageTitle>

<div class="container mt-5">

    <h2 class="text-center fw-bold" style="font-size:40px; font-family: Cambria;">
        Edit Food Item
    </h2>

    <p class="text-muted text-center mb-4" style="font-size:18px;">
        Update the details of your food item
    </p>

    <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8 col-12">

            <div class="card shadow-lg border-0 rounded-4 p-4" style="background:#ffffff;">
                <EditForm Model="MyProduct" OnValidSubmit="HandleUpdateProduct">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="text-center mb-4">
                        @if (!string.IsNullOrEmpty(MyProduct.Base64Img))
                        {
                            <img src="@FixBase64(MyProduct.Base64Img)"
                                 style="height:200px; object-fit:contain;"
                                 class="rounded-4 shadow-sm" />
                        }
                        else
                        {
                            <div class="border border-2 rounded-4 p-4 text-center text-muted"
                                 style="height:200px;">
                                <p class="mt-5">Food Image Preview</p>
                            </div>
                        }
                    </div>

                    <!-- Name -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Food Name</label>
                        <InputText @bind-Value="MyProduct.Name" class="form-control form-control-lg rounded-3" />
                    </div>

                    <!-- Price -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Price</label>
                        <InputNumber @bind-Value="MyProduct.Price" class="form-control form-control-lg rounded-3" />
                    </div>

                    <!-- Quantity -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Quantity</label>
                        <InputNumber @bind-Value="MyProduct.Quantity" class="form-control form-control-lg rounded-3" />
                    </div>

                    <!-- Description -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Description</label>
                        <InputTextArea @bind-Value="MyProduct.Description"
                                       rows="3"
                                       class="form-control rounded-3" />
                    </div>

                    <!-- Upload Image -->
                    <div class="mb-3">
                        <label class="form-label fw-bold @(ImageUploadMessage == "" ? "" : "text-danger")">
                            @(ImageUploadMessage == "" ? "Upload Image (PNG)" : ImageUploadMessage)
                        </label>

                        <InputFile class="form-control form-control-lg rounded-3"
                                   OnChange="UploadImage" />
                    </div>

                    <!-- Buttons -->
                    <div class="d-flex justify-content-between mt-4">
                        <button type="submit" class="btn btn-dark fw-bold px-4 py-2 rounded-3">
                            <i class="fa fa-pen"></i> Update Product
                        </button>
                        <button type="button" class="btn btn-secondary fw-bold px-4 py-2 rounded-3"
                                @onclick="@(() => Nav.NavigateTo("/admin-dashboard"))">
                            Cancel
                        </button>
                    </div>

                </EditForm>
            </div>

        </div>
    </div>

</div>

<MessageDialog @ref="messageDialog"></MessageDialog>

@code {
    [Parameter] public int ProductId { get; set; }

    private Product MyProduct = new();
    private string ImageUploadMessage = "";
    private MessageDialog? messageDialog;

    protected override async Task OnInitializedAsync()
    {
        MyProduct = await Http.GetFromJsonAsync<Product>($"/food/{ProductId}");
    }

    private async Task HandleUpdateProduct()
    {
        if (string.IsNullOrEmpty(MyProduct.Base64Img))
        {
            ImageUploadMessage = "Please upload a PNG image.";
            StateHasChanged();
            return;
        }

        var response = await Http.PutAsJsonAsync($"update-food/{ProductId}", MyProduct);

        if (response.IsSuccessStatusCode)
        {
            messageDialog!.SetDialogValues("success", "Product Updated Successfully!");
            await messageDialog!.ShowMessage();
            Nav.NavigateTo("/admin/products");
        }
        else
        {
            messageDialog!.SetDialogValues("error", "Failed to update product.");
            await messageDialog!.ShowMessage();
        }
    }

    private async Task UploadImage(InputFileChangeEventArgs e)
    {
        if (e.File.Name.ToLower().EndsWith(".png"))
        {
            var format = "image/png";
            var resizeImage = await e.File.RequestImageFileAsync(format, 350, 350);
            var buffer = new byte[resizeImage.Size];
            await resizeImage.OpenReadStream().ReadAsync(buffer);
            MyProduct.Base64Img = $"data:{format};base64,{Convert.ToBase64String(buffer)}";
            ImageUploadMessage = "";
        }
        else
        {
            ImageUploadMessage = "Only PNG files allowed";
        }
    }

    private string FixBase64(string? base64)
    {
        if (string.IsNullOrWhiteSpace(base64))
            return "";

        return base64.Replace("data : image/png;base64,", "data:image/png;base64,");
    }
}
