@page "/add-product"

<PageTitle>Add Product</PageTitle>

<div style="min-height:100vh;" class="container mt-5">

    <h2 class="text-center fw-bold" style="font-size:40px; font-family: Cambria;">
        Add New Food Item
    </h2>

    <p class="text-muted text-center mb-4" style="font-size:18px;">
        Upload delicious food items to your store
    </p>

    <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8 col-12">

            <div class="card shadow-lg border-0 rounded-4 p-4" style="background:#ffffff;">
                <EditForm Model="MyProduct" Enhance OnValidSubmit="HandleSaveProduct">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <!-- Food Image Preview -->
                    <div class="text-center mb-4">
                        @if (!string.IsNullOrEmpty(MyProduct.Base64Img))
                        {
                            <img src="@FixBase64(MyProduct.Base64Img)"
                                 style="height:200px; object-fit:contain;"
                                 class="rounded-4 shadow-sm" />
                        }
                        else
                        {
                            <div class="border border-2 rounded-4 p-4 text-center text-muted"
                                 style="height:200px;">
                                <p class="mt-5">Food Image Preview</p>
                            </div>
                        }
                    </div>

                    <!-- Name -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Food Name</label>
                        <InputText @bind-Value="MyProduct.Name" class="form-control form-control-lg rounded-3" />
                    </div>

                    <!-- Price -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Price</label>
                        <InputNumber @bind-Value="MyProduct.Price" class="form-control form-control-lg rounded-3" />
                    </div>

                    <!-- Quantity -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Quantity</label>
                        <InputNumber @bind-Value="MyProduct.Quantity" class="form-control form-control-lg rounded-3" />
                    </div>

                    <!-- Description -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Description</label>
                        <InputTextArea @bind-Value="MyProduct.Description"
                                       rows="3"
                                       class="form-control rounded-3" />
                    </div>

                    <!-- Upload Image -->
                    <div class="mb-3">
                        <label class="form-label fw-bold @(ImageUploadMessage == "" ? "" : "text-danger")">
                            @(ImageUploadMessage == "" ? "Upload Image (PNG)" : ImageUploadMessage)
                        </label>

                        <InputFile class="form-control form-control-lg rounded-3"
                                   OnChange="UploadImage" />
                    </div>

                    <!-- Buttons -->
                    <div class="d-flex justify-content-between mt-4">
                        @if (ShowSaveButton)
                        {
                            <button type="submit" class="btn btn-dark fw-bold px-4 py-2 rounded-3">
                                <i class="fa fa-plus"></i> Save Product
                            </button>
                        }
                        <BusyButtonComponent ShowBusyButton="ShowBusyButton"></BusyButtonComponent>
                    </div>

                </EditForm>
            </div>

        </div>
    </div>

    <div class="text-center mt-3">
        @reqmessage
    </div>

</div>

<MessageDialog @ref="messageDialog"></MessageDialog>

@code {

    MessageDialog? messageDialog;

    public bool ShowSaveButton { get; set; } = true;
    public bool ShowBusyButton { get; set; } = false;

    string reqmessage = "";
    Product MyProduct = new();
    string ImageUploadMessage = "";

    async Task HandleSaveProduct()
    {
        ShowSaveButton = false;
        ShowBusyButton = true;

        if (string.IsNullOrEmpty(MyProduct.Base64Img))
        {
            messageDialog!.SetDialogValues("warning", "Please upload a PNG image.");
            SetMessageDialog();
            return;
        }

        await Http.PostAsJsonAsync("https://localhost:7119/add-food", MyProduct);

        messageDialog!.SetDialogValues("success", "Product Added Successfully!");
        SetMessageDialog();
        Nav.NavigateTo("/admin/products");
    }

    async Task UploadImage(InputFileChangeEventArgs e)
    {
        if (e.File.Name.ToLower().EndsWith(".png"))
        {
            var format = "image/png";
            var resizeImage = await e.File.RequestImageFileAsync(format, 350, 350);
            var buffer = new byte[resizeImage.Size];
            await resizeImage.OpenReadStream().ReadAsync(buffer);
            MyProduct.Base64Img = $"data:{format};base64,{Convert.ToBase64String(buffer)}";
            ImageUploadMessage = "";
        }
        else
        {
            ImageUploadMessage = "Only PNG files allowed";
        }
    }


    private async void SetMessageDialog()
    {
        await messageDialog!.ShowMessage();
        ShowBusyButton = false;
        ShowSaveButton = true;
        StateHasChanged();
    }

    private string FixBase64(string? base64)
    {
        if (string.IsNullOrWhiteSpace(base64))
            return "";

        return base64.Replace("data : image/png;base64,", "data:image/png;base64,");
    }

}
