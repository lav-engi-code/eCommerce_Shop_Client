@page "/cart"
@using eCommerce_Shop_Client.Services
<PageTitle>Cart</PageTitle>

@if (IsLoading)
{
    <div style="margin-top:15%">
        <div class="loader-container">
            <div class="cube-loader"></div>
        </div>
        <div class="text-center text-secondary fw-bold mt-4">Loading your cart…</div>
    </div>
}
else if (CartItems == null || CartItems.Count == 0)
{
    <di style="min-height:100vh;" class="text-center mt-5">
        <h5 class="text-muted">Your cart is empty!</h5>
        <button class="btn btn-primary mt-3" @onclick="GoHome">Shop Now</button>
    </di>
    <Footer_Page />

}
else
{
    <div style="min-height:100vh;" class="container mt-4">

        <div class="row">

            <!-- LEFT SIDE – CART ITEMS -->
            <div class="col-lg-8">

                @foreach (var item in CartItems)
                {
                    <div class="card shadow-sm mb-3 p-3" style="border-radius:10px;">

                        <div class="row">

                            <!-- Product Image -->
                            <div class="col-4 col-md-3 d-flex align-items-center">
                                <img src="@FixBase64(item.Base64Img)"
                                     style="width:100%; height:120px; object-fit:contain;" />
                            </div>

                            <!-- Product Details -->
                            <div class="col-8 col-md-6">
                                <h5 class="fw-bold mb-1">@item.Name</h5>
                                <p class="fw-semibold text-dark mb-1" style="font-size:18px;">
                                    ₹@item.Price
                                </p>

                                <!-- Quantity control (Flipkart style) -->
                                <div class="d-flex align-items-center mt-2">

                                    <!-- Quantity control (Flipkart style) -->
                                    <div class="d-flex align-items-center mt-2">

                                        <!-- Minus button disabled when qty = 1 -->
                                        <button class="btn btn-outline-dark btn-sm rounded-circle"
                                                style="width:32px; height:32px;"
                                                disabled="@(item.Quantity == 1)"
                                                @onclick="@(() => UpdateQty(item, -1))">
                                            −
                                        </button>

                                        <span class="fw-bold mx-3" style="font-size:17px;">
                                            @item.Quantity
                                        </span>

                                        <!-- Plus button -->
                                        <button class="btn btn-outline-dark btn-sm rounded-circle"
                                                style="width:32px; height:32px;"
                                                @onclick="@(() => UpdateQty(item, +1))">
                                            +
                                        </button>

                                    </div>


                                    <span class="fw-bold mx-3" style="font-size:17px;">
                                        <span>Subtotal</span>
                                        <span>₹@(item.Price* item.Quantity)</span>
                                    </span>

                                </div>

                                <button class="btn btn-light border-0 text-danger mt-2 p-0"
                                        title="Remove"
                                        @onclick="@(() => RemoveItem(item.Id))"
                                        style="font-size:20px; line-height:1;">
                                    &times;
                                </button>

                            </div>

                        </div>

                    </div>
                }
            </div>

            <!-- RIGHT SIDE – PRICE SUMMARY -->
            <div class="col-lg-4">

                <div class="card shadow-sm p-3" style="border-radius:10px; position:sticky; top:90px;">

                    <h5 class="fw-bold mb-3">PRICE DETAILS</h5>

                    <div class="d-flex justify-content-between mb-2">
                        <span>Total</span>
                        <span>₹@Subtotal</span>
                    </div>

                    <div class="d-flex justify-content-between mb-2">
                        <span>GST (12%)</span>
                        <span>₹@GstAmount</span>
                    </div>

                    <hr />

                    <div class="d-flex justify-content-between fw-bold mb-3" style="font-size:18px;">
                        <span>Total Amount</span>
                        <span>₹@GrandTotal</span>
                    </div>

                    <button class="btn btn-warning fw-bold w-100 py-2"
                            style="font-size:18px;"
                            @onclick="Checkout">
                        PLACE ORDER
                    </button>

                </div>

            </div>

        </div>

    </div>
    <Footer_Page />

}

@code {
    [Inject] CartState CartState { get; set; }

    private List<Cart>? CartItems;
    private bool IsLoading = true;

    private decimal Subtotal = 0;
    private decimal GstAmount = 0;
    private decimal GrandTotal = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadCart();
    }

    private async Task LoadCart()
    {
        IsLoading = true;

        CartItems = await Http.GetFromJsonAsync<List<Cart>>("cart/get");
        int totalQty = CartItems.Sum(i => i.Quantity);
        CartState.SetItems(totalQty);
        CalculateTotal();

        IsLoading = false;
    }

    private void CalculateTotal()
    {
        Subtotal = CartItems?.Sum(i => i.Price * i.Quantity) ?? 0;
        GstAmount = Math.Round(Subtotal * 0.12m, 2);
        GrandTotal = Subtotal + GstAmount;
    }

    private async Task UpdateQty(Cart item, int change)
    {
        var newQty = item.Quantity + change;
        if (newQty < 1) newQty = 1;

        item.Quantity = newQty;

        await Http.PutAsync($"cart/update-qty/{item.Id}/{newQty}", null);
        int totalQty = CartItems.Sum(i => i.Quantity);
        CartState.SetItems(totalQty);
        CalculateTotal();
    }

    private async Task RemoveItem(int id)
    {
        await Http.DeleteAsync($"cart/remove/{id}");
        CartItems!.RemoveAll(i => i.Id == id);
        int totalQty = CartItems.Sum(i => i.Quantity);
        CartState.SetItems(totalQty);
        CalculateTotal();
    }

    private void Checkout()
    {
        if (LoginState.IsLoggedIn)
        {
            Nav.NavigateTo("/save-address");
        }
        else
        {
            Nav.NavigateTo("/login");
        }
    }

    private void GoHome()
    {
        Nav.NavigateTo("/");
    }

    private string FixBase64(string? base64)
    {
        if (string.IsNullOrWhiteSpace(base64))
            return "";

        base64 = base64.Trim();

        string[] wrongPrefixes =
        {
            "data : image/png;base64,",
            "data:image/png;base64,",
            "data:image/png;base64",
            "data:image/PNG;base64,"
        };

        foreach (var p in wrongPrefixes)
        {
            base64 = base64.Replace(p, "", StringComparison.OrdinalIgnoreCase);
        }

        return $"data:image/png;base64,{base64.Trim()}";
    }
}
