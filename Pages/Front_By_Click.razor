@inject CartState CartState

@if (SelectedProduct == null)
{
    <div class="loader-wrapper">
        <div class="cube-loader"></div>
        <p class="text-center text-secondary mt-3">Bringing Your Delicious Selection...</p>
    </div>
}
else
{
    <div class="container d-flex justify-content-center align-items-center"
         style="min-height:80vh;">

        <div class="row bg-white rounded p-4"
             style="max-width:800px; width:100%;">

            <!-- IMAGE -->
            <div class="col-12 text-center mb-3">
                <img src="@FixBase64(SelectedProduct.Base64Img)"
                     style="width:320px; border-radius:15px;" />
            </div>

            <!-- DETAILS -->
            <div class="col-12 text-center">

                <h1 style="font-weight:bold; font-size:32px;">
                    @SelectedProduct.Name
                    <span style="
                        background:#ffc107;
                        padding:4px 12px;
                        border-radius:10px;
                        font-size:18px;
                        margin-left:10px;">
                        ₹@SelectedProduct.Price
                    </span>
                </h1>

                <p style="color:#555; font-size:16px; margin-top:10px;">
                    @SelectedProduct.Description
                </p>

                <p style="font-weight:bold; margin-top:20px;">START GRILLING ON</p>

                <!-- BUTTONS CENTERED -->
                <div class="d-flex justify-content-center gap-2 mt-3">

                    <button class="btn btn-secondary" @onclick="GoBack">
                        <i class="fa fa-arrow-left"></i> Back
                    </button>

                    <button class="btn btn-warning" @onclick="AddToCart">
                        <i class="fa fa-shopping-cart"></i> Add to Cart
                    </button>

                    <button class="btn btn-danger" @onclick="PaymentMethod">
                        <i class="fa fa-cart-plus"></i> Buy Now
                    </button>

                </div>

                @if (!string.IsNullOrEmpty(Message))
                {
                    <p style="color:green; font-weight:bold; margin-top:15px;">
                        @Message
                    </p>
                }

            </div>
        </div>
    </div>

}


@code {
    private string Message = "";

    [Parameter]
    public int ProductId { get; set; }

    private Product? SelectedProduct;

    protected override async Task OnInitializedAsync()
    {
        SelectedProduct = await Http.GetFromJsonAsync<Product>($"/food/{ProductId}");
    }

    private string FixBase64(string? base64)
    {
        if (string.IsNullOrWhiteSpace(base64))
            return "";

        string[] wrongPrefixes =
        {
            "data : image/png;base64,",
            "data:image/png;base64,",
            "data:image/png;base64",
            "data:image/PNG;base64,"
    };

        foreach (var p in wrongPrefixes)
        {
            base64 = base64.Replace(p, "", StringComparison.OrdinalIgnoreCase);
        }

        return $"data:image/png;base64,{base64.Trim()}";
    }

    private void GoBack()
    {
        Nav.NavigateTo("/");
    }

    private void PaymentMethod()
    {
        if (LoginState.IsLoggedIn)
        {
            Nav.NavigateTo("/save-address");
        }
        else
        {
            Nav.NavigateTo("/login");
        }
    }

    private async Task AddToCart()
    {
        if (SelectedProduct == null)
            return;

        var cartItem = new Product
        {
            Name = SelectedProduct.Name,
            Description = SelectedProduct.Description,
            Price = SelectedProduct.Price,
            Base64Img = SelectedProduct.Base64Img,
            Quantity = 1
        };

        var res = await Http.PostAsJsonAsync("/cart/add", cartItem);
        var list = await Http.GetFromJsonAsync<List<Cart>>("cart/get");
        int totalQty = list.Sum(i => i.Quantity);
        CartState.SetItems(totalQty);
        Message = res.IsSuccessStatusCode ? "✔ Added to cart!" : "❌ Failed!";

        await Task.Delay(3000);
        Message = "";
        StateHasChanged();
    }
}
